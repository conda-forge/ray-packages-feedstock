From e5f2cf9b5590a948fbe93276da2347be322b0cae Mon Sep 17 00:00:00 2001
From: Kai Fricke <kai@anyscale.com>
Date: Wed, 4 Aug 2021 11:24:44 +0100
Subject: [PATCH 05/12] Contain bazel root and output dir right above $SRC_DIR

Signed-off-by: Kai Fricke <kai@anyscale.com>
---
 python/setup.py | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/python/setup.py b/python/setup.py
index 981bad8a1..df3a888d4 100644
--- a/python/setup.py
+++ b/python/setup.py
@@ -298,13 +298,23 @@ def build(build_python, build_java, build_cpp):
         logger.warning("Expected Bazel version {} but found {}".format(
             ".".join(map(str, SUPPORTED_BAZEL)), bazel_version_str))
 
+    root_dir = os.path.join(
+        os.path.abspath(os.environ["SRC_DIR"]), "..", "bazel-root")
+    out_dir = os.path.join(os.path.abspath(os.environ["SRC_DIR"]), "..", "b-o")
+
+    for d in (root_dir, out_dir):
+        if not os.path.exists(d):
+            os.makedirs(d)
+
     bazel_targets = []
     bazel_targets += ["//:ray_pkg"] if build_python else []
     bazel_targets += ["//cpp:ray_cpp_pkg"] if build_cpp else []
     bazel_targets += ["//java:ray_java_pkg"] if build_java else []
     return bazel_invoke(
-        subprocess.check_call,
-        ["build", "--verbose_failures", "--"] + bazel_targets,
+        subprocess.check_call, [
+            "--output_user_root=" + root_dir, "--output_base=" + out_dir,
+            "build", "--verbose_failures", "--"
+        ] + bazel_targets,
         env=bazel_env)
 
 
-- 
2.26.2

